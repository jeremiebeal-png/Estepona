<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carte — Quartiers d’Estepona</title>
  <meta name="description" content="Carte interactive des quartiers d’Estepona (zones indicatives, éditables) avec export GeoJSON." />
  <link rel="preload" href="styles.css" as="style" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🌴</text></svg>">

  <!-- Leaflet + Leaflet.draw -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

  <style>
    #map{width:100%; height:560px; border-radius:16px; border:1px solid rgba(148,163,184,.15); box-shadow: var(--shadow)}
    .map-tools{display:flex; gap:10px; flex-wrap:wrap; margin:12px 0 16px}
    .legend{display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-top:10px; color:var(--muted)}
    .legend .item{display:flex; align-items:center; gap:8px}
    .legend .swatch{width:14px; height:14px; border-radius:3px; border:1px solid rgba(148,163,184,.35)}
    .leaflet-popup-content-wrapper{background:#0b1220;color:var(--text);border:1px solid rgba(148,163,184,.25)}
    .leaflet-popup-tip{background:#0b1220}
    body.light .leaflet-popup-content-wrapper, body.light .leaflet-popup-tip{ background:#ffffff; color:#0f172a; border-color: rgba(15,23,42,.15) }
  </style>
</head>
<body>
<header class="site-header">
  <div class="container header-inner">
    <a class="brand" href="index.html">🌴 Estepona en Français</a>
    <button id="theme-toggle" class="btn" type="button">Mode clair</button>
    <button class="nav-toggle" aria-expanded="false" aria-controls="site-nav" aria-label="Ouvrir le menu">
      <span></span><span></span><span></span>
    </button>
    <nav id="site-nav" class="site-nav">
      <a href="index.html#decouvrir">Découvrir</a>
      <a href="index.html#plages">Plages & Chiringuitos</a>
      <a href="index.html#restaurants">Restaurants</a>
      <a href="index.html#installer">S’installer</a>
      <a href="index.html#blog">Blog</a>
      <a href="index.html#contact">Contact</a>
    </nav>
  </div>
</header>

<main>
  <section class="section">
    <div class="container">
      <a class="btn" href="index.html">← Retour à l’accueil</a>
      <header class="section-head" style="margin-top:12px">
        <h2>Quartiers d’Estepona — Carte interactive</h2>
        <p>Contours <em>indicatifs</em> — active “Modifier les zones” pour ajuster à la souris puis “Exporter” (GeoJSON).</p>
      </header>

      <div class="map-tools">
        <button id="toggleEdit" class="btn">✏️ Modifier les zones</button>
        <button id="exportGeoJSON" class="btn">⬇️ Exporter (GeoJSON)</button>
        <span class="note">Astuce : zoome sur une zone, clique une forme → fais glisser les poignées. Double‑clic pour terminer un sommet.</span>
      </div>

      <div id="map" role="region" aria-label="Carte des quartiers d’Estepona"></div>
      <div class="legend" id="legend"></div>
    </div>
  </section>
</main>

<footer class="site-footer">
  <div class="container footer-inner">
    <p>© <span id="year"></span> Estepona en Français — Guide non officiel</p>
    <nav class="footer-nav">
      <a href="index.html#accueil">Haut de page</a>
      <a href="index.html#contact">Contact</a>
      <a href="#" rel="nofollow">Mentions légales</a>
    </nav>
  </div>
</footer>

<script src="app.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
(function(){
  // ---- Carte
  const map = L.map('map', {scrollWheelZoom:true}).setView([36.43, -5.15], 12.9);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap &copy; CARTO'
  }).addTo(map);

  // ---- Couleurs (harmonie avec la charte)
  const palette = ['#22d3ee','#fbbf24','#34d399','#60a5fa','#f472b6','#a78bfa','#fb7185','#f59e0b','#10b981','#38bdf8','#ef4444','#eab308'];
  const pick = (i)=> palette[i % palette.length];

  // ---- Utilitaires : créer un petit polygone rectangulaire à partir d’un centre
  function boxAround([lat, lon], dLat=0.004, dLon=0.006){
    return [[lat+dLat, lon-dLon],[lat+dLat, lon+dLon],[lat-dLat, lon+dLon],[lat-dLat, lon-dLon]];
  }

  // ---- Zones (centres approximatifs – à affiner avec le mode édition)
  // CÔTE OUEST -> CENTRE -> EST (du large Ouest vers Marbella)
  const ZONES_META = [
    // OUEST
    ['Bahía Dorada',           [36.439, -5.192]],
    ['Valle Romano',           [36.435, -5.205]],
    ['Costa Natura',           [36.436, -5.181]],
    ['Seghers',                [36.420, -5.166]],
    ['Puerto',                 [36.420, -5.159]],
    ['Plaza Toros',            [36.421, -5.160]],
    ['Virgen del Mar',         [36.427, -5.160]],
    ['Huerta Nueva',           [36.428, -5.166]],
    ['Parque Central',         [36.429, -5.150]],
    ['Estadio',                [36.433, -5.155]],
    ['Casco Antiguo',          [36.425, -5.148]],
    ['Altos de Estepona',      [36.445, -5.161]],
    // BANDE CÔTE URBAINE
    ['Punta Plata',            [36.419, -5.136]],
    ['Kempinski',              [36.431, -5.168]],
    ['Los Llanos',             [36.432, -5.152]],
    ['Las Lomas',              [36.434, -5.135]],
    // VERS L’EST / SELWO
    ['Selwo',                  [36.455, -5.073]],
    ['La Concha-Resina Golf',  [36.452, -5.085]],
    ['Sotoserena',             [36.450, -5.067]],
    ['Guadalmansa',            [36.451, -5.059]],
    ['El Velerín',             [36.451, -5.057]],
    ['Cancelada',              [36.452, -5.042]],
    ['Bel-Air',                [36.465, -5.031]],
    ['Benamara',               [36.455, -5.026]],
    ['Paraiso Borrnal',        [36.481, -5.040]],   // (Paraíso-Borronal)
    ['Atalaya-Isdabe',         [36.467, -5.018]],
    ['Nueva Atalaya',          [36.472, -5.014]],
    // GRAND SECTEUR NORD-OUEST
    ['Sierra Bermeja',         [36.540, -5.210]],
    // POSSIBLE QUARTIER ÉCRIT "Lagaspara" (hyp : zone ouest/nord du centre)
    ['Lagaspara',              [36.440, -5.175]],
    // PEBELLÓN (complexe sportif municipal à l’est du centre)
    ['Pebellon',               [36.433, -5.133]]
  ];

  // ---- Création du calque des zones + édition
  const zonesGroup = L.featureGroup().addTo(map);

  const zones = ZONES_META.map((z, idx)=>{
    const [name, center] = z;
    const poly = L.polygon(boxAround(center), {
      color: pick(idx), weight: 2, fillColor: pick(idx), fillOpacity: .22
    }).addTo(zonesGroup)
      .bindPopup(`<b>${name}</b><br><small>Contour indicatif — modifiable</small>`);
    // Label
    const labelPos = poly.getBounds().getCenter();
    L.marker(labelPos, {
      interactive:false,
      icon: L.divIcon({className:'', html:`<div style="padding:2px 6px;border-radius:8px;background:rgba(0,0,0,.45);color:#fff;font-size:12px">${name}</div>`})
    }).addTo(zonesGroup);
    return {name, center, color: pick(idx), layer: poly};
  });

  // ---- Légende
  const legend = document.getElementById('legend');
  legend.innerHTML = zones.map(z=>`<span class="item"><span class="swatch" style="background:${z.color}"></span>${z.name}</span>`).join('');

  // ---- Fit bounds
  map.fitBounds(zonesGroup.getBounds().pad(0.2));

  // ---- Edition (Leaflet.draw)
  const drawControl = new L.Control.Draw({
    edit: {
      featureGroup: zonesGroup,
      edit: true, remove: false
    },
    draw: false
  });
  let editOn = false;
  document.getElementById('toggleEdit').addEventListener('click', ()=>{
    editOn = !editOn;
    const btn = document.getElementById('toggleEdit');
    if(editOn){ map.addControl(drawControl); btn.classList.add('primary'); btn.textContent='✅ Terminer la modification'; }
    else{ map.removeControl(drawControl); btn.classList.remove('primary'); btn.textContent='✏️ Modifier les zones'; }
  });

  // ---- Export GeoJSON
  document.getElementById('exportGeoJSON').addEventListener('click', ()=>{
    const fc = zonesGroup.toGeoJSON();
    const blob = new Blob([JSON.stringify(fc, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'quartiers-estepona.geojson';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });
})();
</script>
</body>
</html>
