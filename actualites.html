<script>
  // ==========
  // Actus : dataset + filtres (même style que index.html)
  // ==========

  const dataEl = document.getElementById('dataset-actus');
  const grid = document.getElementById('grid');
  const q = document.getElementById('q');
  const catChips = Array.from(document.querySelectorAll('[data-cat]'));
  const periodRadios = Array.from(document.querySelectorAll('input[name="period"]'));

  const PLACEHOLDER_IMG = 'img/placeholder-1.jpg';
  let items = [];

  function parseJSON(el){
    if(!el) return [];
    try { return JSON.parse(el.textContent.trim()); }
    catch(e){ return []; }
  }

  function parseISO(s){
    const d = new Date(s);
    return isNaN(d) ? null : d;
  }

  function fmtDateFR(iso){
    const d = parseISO(iso);
    return d ? d.toLocaleDateString('fr-FR') : '';
  }

  function esc(str){
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function getSelectedCats(){
    return catChips
      .filter(c => c.checked)
      .map(c => (c.dataset.cat || '').toLowerCase())
      .filter(Boolean);
  }

  function getPeriod(){
    return (periodRadios.find(r => r.checked) || {}).value || '30';
  }

  function withinPeriod(iso, periodValue, now){
    if(periodValue === 'all') return true;
    const d = parseISO(iso);
    if(!d) return true; // si date manquante, on n’exclut pas
    const days = parseInt(periodValue, 10);
    if(!Number.isFinite(days)) return true;
    return (now - d) <= days * 86400000;
  }

  function cardHTML(it){
    const title = esc(it.titre);
    const link  = esc(it.lien || '#');
    const cat   = esc(it.categorie || '');
    const date  = esc(fmtDateFR(it.date));
    const img   = esc(it.image || PLACEHOLDER_IMG);
    const resume= esc(it.resume || '');
    const tags  = Array.isArray(it.tags) ? it.tags : [];

    // Si lien externe, on ouvre dans un nouvel onglet ; sinon, navigation normale
    const isExternal = /^https?:\/\//i.test(it.lien || '');
    const aAttrs = isExternal ? ' target="_blank" rel="noopener"' : '';

    return `
      <article class="card">
        <a class="thumb" href="${link}"${aAttrs}>
          <img src="${img}" alt="${title}" loading="lazy" decoding="async" data-fallback="${PLACEHOLDER_IMG}">
        </a>
        <div class="body">
          <div class="kicker">
            <span class="tag">${cat}</span>
            <span class="tag">${date}</span>
          </div>
          <h3><a href="${link}"${aAttrs}>${title}</a></h3>
          <p class="meta">${tags.map(t => `<span class="tag">${esc(t)}</span>`).join(' ')}</p>
          <p>${resume}</p>
        </div>
      </article>
    `;
  }

  function attachImageFallback(){
    grid?.querySelectorAll('img[data-fallback]').forEach(img => {
      img.addEventListener('error', () => {
        const fb = img.getAttribute('data-fallback') || PLACEHOLDER_IMG;
        if(img.src.endsWith(fb)) return;
        img.src = fb;
      }, { once:false });
    });
  }

  function render(list){
    if(!grid) return;

    const sorted = [...list].sort((a,b) => {
      const da = parseISO(a.date)?.getTime() ?? 0;
      const db = parseISO(b.date)?.getTime() ?? 0;
      return db - da;
    });

    grid.innerHTML = sorted.map(cardHTML).join('');
    attachImageFallback();
  }

  function applyFilters(){
    const now = new Date();

    const txt = (q?.value || '').toLowerCase().trim();
    const cats = getSelectedCats();
    const periodValue = getPeriod();

    const filtered = items.filter(it => {
      const hay = [
        it.titre,
        it.categorie,
        ...(Array.isArray(it.tags) ? it.tags : []),
        it.resume
      ].join(' ').toLowerCase();

      const okText = !txt || hay.includes(txt);
      const okCat  = !cats.length || cats.includes((it.categorie || '').toLowerCase());
      const okPeriod = withinPeriod(it.date, periodValue, now);

      return okText && okCat && okPeriod;
    });

    render(filtered);
  }

  // Init
  items = parseJSON(dataEl);
  render(items);

  // Events
  q?.addEventListener('input', applyFilters);
  catChips.forEach(c => c.addEventListener('change', applyFilters));
  periodRadios.forEach(r => r.addEventListener('change', applyFilters));
</script>
